
const pad2 = require('./tools').pad2;
const stateDefinition = [
    // DTU
    {
        type: 'dtu',
        name: 'OpenDTU',
        desc: 'The OpenDTU Device',
        states: [
            {
                id: 'available',
                prob: 'status',
                name: 'Available',
                role: 'indicator.reachable',
                write: false,
                read: true,
                type: 'boolean',
                def: false,
                getter: x => x === 'online',
            },
            {
                id: 'ip',
                prob: 'ip',
                name: 'IP address of OpenDTU',
                role: 'info.ip',
                write: false,
                read: true,
                type: 'string',
                def: '0.0.0.0',
            },
            {
                id: 'hostname',
                prob: 'hostname',
                name: 'Current hostname of the dtu (as set in web GUI)',
                role: 'info.name ',
                write: false,
                read: true,
                type: 'string',
                def: '',
            },
            {
                id: 'rssi',
                prob: 'rssi',
                name: 'WiFi network quality',
                role: 'state',
                write: false,
                read: true,
                unit: 'db',
                type: 'number',
                def: 0,
                getter: x => Number(x),
            },
            {
                id: 'uptime',
                prob: 'uptime',
                name: 'Time in seconds since startup',
                role: 'state',
                write: false,
                read: true,
                type: 'string',
                def: '0',
                getter: x => {
                    const seconds = pad2(Math.trunc(x % 60));
                    const miutes = pad2(Math.trunc((x / 60) % 60));
                    const houres = pad2(Math.trunc((x / 60 / 60) % 24));
                    const days = Math.trunc(x / 60 / 60 / 24);
                    return `${days} Days ${houres}:${miutes}:${seconds}`;
                },
            },
        ]
    },
    // Info
    {
        type: 'info',
        name: 'Info',
        desc: '',
        states: [
            {
                id: 'available',
                prob: 'reachable',
                name: 'Indicates whether the inverter is reachable',
                role: 'indicator.reachable',
                write: false,
                read: true,
                type: 'boolean',
                def: false,
                getter: x => x == 1,
            },
            {
                id: 'name',
                prob: 'name',
                name: 'Name of the inverter as configured in web GUI',
                role: 'state',
                write: false,
                read: true,
                type: 'string',
                def: '',
            },
            {
                id: 'bootloaderversion',
                prob: 'bootloaderversion',
                name: 'Bootloader version of the inverter',
                role: 'state',
                write: false,
                read: true,
                type: 'string',
                def: '',
            },
            {
                id: 'fwbuildversion',
                prob: 'fwbuildversion',
                name: 'Firmware version of the inverter',
                role: 'state',
                write: false,
                read: true,
                type: 'string',
                def: '',
            },
            {
                id: 'fwbuilddatetime',
                prob: 'fwbuilddatetime',
                name: 'Build date / time of inverter firmware',
                role: 'state',
                write: false,
                read: true,
                type: 'string',
                def: '',
            },
            {
                id: 'hwpartnumber',
                prob: 'hwpartnumber',
                name: 'Hardware part number of the invertere',
                role: 'state',
                write: false,
                read: true,
                type: 'number',
                def: 0,
                getter: x => Number(x),
            },
            {
                id: 'hwversion',
                prob: 'hwversion',
                name: 'Hardware version of the inverter',
                role: 'state',
                write: false,
                read: true,
                type: 'string',
                def: '',
            },
            {
                id: 'producing',
                prob: 'producing',
                name: 'Indicates whether the inverter is producing AC power',
                role: 'state',
                write: false,
                read: true,
                type: 'boolean',
                def: false,
                getter: x => x == 1,
            },
            {
                id: 'last_update',
                prob: 'last_update',
                name: 'Unix timestamp of last inverter statistics udpate',
                role: 'state',
                write: false,
                read: true,
                type: 'string',
                def: '',
                getter: x => {
                    const date = new Date(x * 1000);
                    date.setMinutes(date.getMinutes() - date.getTimezoneOffset());
                    return date.toISOString().replace('T', ' ').replace('.000Z', '');
                },
            },
        ]
    },
    // AC channel
    {
        type: 'inverter',
        name: 'Inverter',
        desc: '',
        states: [
            {
                id: 'current',
                prob: 'current',
                name: 'AC current in ampere',
                role: 'state',
                write: false,
                read: true,
                type: 'number',
                unit: 'A',
                def: 0,
                getter: x => Number(x),
            },
            {
                id: 'efficiency',
                prob: 'efficiency',
                name: 'Ratio AC Power over DC Power in percent',
                role: 'state',
                write: false,
                read: true,
                type: 'number',
                unit: '%',
                def: 0,
                getter: x => Number(x),
            },
            {
                id: 'frequency',
                prob: 'frequency',
                name: 'AC frequency in hertz',
                role: 'state',
                write: false,
                read: true,
                type: 'number',
                unit: 'Hz',
                def: 0,
                getter: x => Number(x),
            },
            {
                id: 'power',
                prob: 'power',
                name: 'AC active power in watts',
                role: 'state',
                write: false,
                read: true,
                type: 'number',
                unit: 'W',
                def: 0,
                getter: x => Number(x),
            },
            {
                id: 'powerdc',
                prob: 'powerdc',
                name: 'DC power in watts',
                role: 'state',
                write: false,
                read: true,
                type: 'number',
                unit: 'W',
                def: 0,
                getter: x => Number(x),
            },
            {
                id: 'powerfactor',
                prob: 'powerfactor',
                name: 'Power factor in percent',
                role: 'state',
                write: false,
                read: true,
                type: 'number',
                unit: '%',
                def: 0,
                getter: x => Number(x),
            },
            {
                id: 'reactivepower',
                prob: 'reactivepower',
                name: 'AC reactive power in VAr',
                role: 'state',
                write: false,
                read: true,
                type: 'number',
                unit: 'VAr',
                def: 0,
                getter: x => Number(x),
            },
            {
                id: 'temperature',
                prob: 'temperature',
                name: 'Temperature of inverter in degree celsius',
                role: 'state',
                write: false,
                read: true,
                type: 'number',
                unit: 'Â°C',
                def: 0,
                getter: x => Number(x),
            },
            {
                id: 'voltage',
                prob: 'voltage',
                name: 'AC voltage in volt',
                role: 'state',
                write: false,
                read: true,
                type: 'number',
                unit: 'V',
                def: 0,
                getter: x => Number(x),
            },
            {
                id: 'yieldday',
                prob: 'yieldday',
                name: 'Energy converted to AC per day in watt hours',
                role: 'state',
                write: false,
                read: true,
                type: 'number',
                unit: 'Wh',
                def: 0,
                getter: x => Number(x),
            },
            {
                id: 'yieldtotal',
                prob: 'yieldtotal',
                name: 'Energy converted to AC since reset watt hours',
                role: 'state',
                write: false,
                read: true,
                type: 'number',
                unit: 'kWh',
                def: 0,
                getter: x => Number(x),
            },
        ]
    },
    // DC channel
    {
        type: 'dc_channel',
        name: 'DC Input %INPUTNUMBER%',
        desc: 'String %INPUTNUMBER%',
        states: [
            {
                id: 'name',
                prob: 'name',
                name: 'Name of the DC input channel as configured in web GUI',
                role: 'state',
                write: false,
                read: true,
                type: 'string',
                def: '',
            },
            {
                id: 'current',
                prob: 'current',
                name: 'DC current of specific input in ampere',
                role: 'state',
                write: false,
                read: true,
                type: 'number',
                unit: 'A',
                def: 0,
                getter: x => Number(x),
            },
            {
                id: 'irradiation',
                prob: 'irradiation',
                name: 'Ratio DC Power over set maximum power (in web GUI)',
                role: 'state',
                write: false,
                read: true,
                type: 'number',
                unit: '%',
                def: 0,
                getter: x => Number(x),
            },
            {
                id: 'power',
                prob: 'power',
                name: 'DC power of specific input in watt',
                role: 'state',
                write: false,
                read: true,
                type: 'number',
                unit: 'W',
                def: 0,
                getter: x => Number(x),
            },
            {
                id: 'voltage',
                prob: 'voltage',
                name: 'DC voltage of specific input in volt',
                role: 'state',
                write: false,
                read: true,
                type: 'number',
                unit: 'V',
                def: 0,
                getter: x => Number(x),
            },
            {
                id: 'yieldday',
                prob: 'yieldday',
                name: 'Energy converted to AC per day on specific input',
                role: 'state',
                write: false,
                read: true,
                type: 'number',
                unit: 'Wh',
                def: 0,
                getter: x => Number(x),
            },
            {
                id: 'yieldtotal',
                prob: 'yieldtotal',
                name: 'Energy converted to AC since reset on specific input',
                role: 'state',
                write: false,
                read: true,
                type: 'number',
                unit: 'kWh',
                def: 0,
                getter: x => Number(x),
            },
        ]
    },
    // Inverter limit
    {
        type: 'inverter_limit',
        name: 'Control power of inverter',
        desc: '',
        states: [
            {
                id: 'limit_relative',
                prob: 'limit_relative',
                name: 'Current applied production limit of the inverter',
                role: 'state',
                write: false,
                read: true,
                type: 'number',
                unit: '%',
                def: 0,
                getter: x => Number(x),
            },
            {
                id: 'limit_absolute',
                prob: 'limit_absolute',
                name: 'Current applied production limit of the inverter',
                role: 'state',
                write: false,
                read: true,
                type: 'number',
                unit: 'W',
                def: 0,
                getter: x => Number(x),
            },
            {
                id: 'limit_persistent_relative',
                prob: 'limit_persistent_relative',
                name: 'Set the inverter limit as a percentage of total production capability. The value will survive the night without power. The updated value will show up in the web GUI and limit_relative topic immediatly.',
                role: 'state',
                write: true,
                read: true,
                type: 'number',
                unit: '%',
                def: 0,
                getter: x => Number(x),
                setter: x => String(x)
            },
            {
                id: 'limit_persistent_absolute',
                prob: 'limit_persistent_absolute',
                name: 'Set the inverter limit as a absolute value. The value will survive the night without power. The updated value will set immediatly within the inverter but show up in the web GUI and limit_relative topic after around 4 minutes. If you are using a already known inverter (known Hardware ID), the updated value will show up within a few seconds.',
                role: 'state',
                write: true,
                read: true,
                type: 'number',
                unit: 'W',
                def: 0,
                getter: x => Number(x),
                setter: x => String(x)
            },

            {
                id: 'limit_nonpersistent_relative',
                prob: 'limit_nonpersistent_relative',
                name: 'Set the inverter limit as a percentage of total production capability. The value will reset to the last persistent value at night without power. The updated value will show up in the web GUI and limit_relative topic immediatly. The value must be published non-retained, otherwise it will be ignored!',
                role: 'state',
                write: true,
                read: true,
                type: 'number',
                unit: '%',
                def: 0,
                getter: x => Number(x),
                setter: x => String(x)
            },
            {
                id: 'limit_nonpersistent_absolute',
                prob: 'limit_nonpersistent_absolute',
                name: 'Set the inverter limit as a absolute value. The value will reset to the last persistent value at night without power. The updated value will set immediatly within the inverter but show up in the web GUI and limit_relative topic after around 4 minutes. If you are using a already known inverter (known Hardware ID), the updated value will show up within a few seconds. The value must be published non-retained, otherwise it will be ignored!',
                role: 'state',
                write: true,
                read: true,
                type: 'number',
                unit: 'W',
                def: 0,
                getter: x => Number(x),
                setter: x => String(x)
            },
            {
                id: 'power_switch',
                prob: 'power',
                name: 'Turn the inverter on or off',
                role: 'state',
                write: true,
                read: true,
                type: 'boolean',
                def: true,
                getter: x => x == 1,
                setter: x => x ? '1' : '0',
            },
            {
                id: 'restart',
                prob: 'restart',
                name: 'Restarts the inverters (also resets YieldDay)',
                role: 'button',
                write: true,
                read: true,
                type: 'boolean',
                def: true,
                setter: x => x ? '1' : '0',
            },
        ]
    }
];

module.exports = {
    stateDefinition: stateDefinition,
};